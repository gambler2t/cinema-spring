<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${movie.title}">–§–∏–ª—å–º</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

<header class="topbar">
    <div class="brand"><a th:href="@{/}">Absolute cinema</a></div>
    <nav>
        <a th:href="@{/movies}">–§–∏–ª—å–º—ã</a>
        <a th:href="@{/about}">–û –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–µ</a>
        <span th:if="${#authorization.expression('hasRole(''USER'')')}">
            <a th:href="@{/user/profile}">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a th:href="@{/user/favorites}">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
        </span>
        <span th:if="${#authorization.expression('isAnonymous()')}">
            <a th:href="@{/tickets/guest}">–ú–æ–∏ –±–∏–ª–µ—Ç—ã</a>
        </span>
        <span th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
            <a th:href="@{/admin/movies}">–ê–¥–º–∏–Ω</a>
        </span>
    </nav>
    <div class="auth">
        <a th:if="${#authorization.expression('isAnonymous()')}"
           th:href="@{/login}">–í–æ–π—Ç–∏</a>
        <span th:if="${#authorization.expression('isAuthenticated()')}">
            <span th:text="${#authentication.name}">user</span>
            <form th:action="@{/logout}" method="post" class="inline">
                <button type="submit" class="link-button">–í—ã–π—Ç–∏</button>
            </form>
        </span>
        <button type="button" class="theme-toggle" onclick="toggleTheme()">
            üåô –¢—ë–º–Ω–∞—è
        </button>
    </div>
</header>

<main class="container movie-details">
    <section class="movie-hero">
        <div class="movie-hero-poster">
            <img th:if="${movie.posterUrl != null and !movie.posterUrl.isEmpty()}"
                 th:src="${movie.posterUrl}"
                 th:alt="${movie.title}">
            <div th:if="${movie.posterUrl == null or movie.posterUrl.isEmpty()}"
                 class="movie-poster-placeholder">
                –ù–ï–¢ –ü–û–°–¢–ï–†–ê
            </div>
        </div>
        <div class="movie-hero-info">
            <h1 th:text="${movie.title}">–ù–∞–∑–≤–∞–Ω–∏–µ</h1>

            <div class="movie-hero-actions">
                <!-- –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <form th:if="${#authorization.expression('hasRole(''USER'')')}"
                      th:action="@{/user/favorites/{id}/toggle(id=${movie.id})}"
                      method="post"
                      class="inline">
                    <button type="submit"
                            class="btn"
                            th:class="${isFavorite} ? 'btn-danger' : 'btn-secondary'"
                            th:text="${isFavorite} ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'">
                        –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    </button>
                </form>
            </div>

            <p><strong>–ñ–∞–Ω—Ä:</strong>
                <span th:text="${movie.genre != null ? movie.genre : '–ù–µ —É–∫–∞–∑–∞–Ω'}">–ñ–∞–Ω—Ä</span>
            </p>

            <p><strong>–†–µ–∂–∏—Å—Å—ë—Ä:</strong>
                <span th:text="${movie.director != null ? movie.director : '–ù–µ —É–∫–∞–∑–∞–Ω'}">–†–µ–∂–∏—Å—Å—ë—Ä</span>
            </p>

            <p><strong>–°—Ç—Ä–∞–Ω–∞:</strong>
                <span th:text="${movie.country != null ? movie.country : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}">–°—Ç—Ä–∞–Ω–∞</span>
            </p>

            <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong>
                <span th:text="${movie.durationMinutes != null ? movie.durationMinutes : '‚Äî'}">120</span> –º–∏–Ω
            </p>
        </div>
    </section>

    <section class="movie-description" th:if="${movie.description != null and !movie.description.isEmpty()}">
        <h2>–û–ø–∏—Å–∞–Ω–∏–µ</h2>
        <p th:text="${movie.description}">
            –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞...
        </p>
    </section>

    <!-- –ù–û–í–´–ô –ë–õ–û–ö –° –°–ï–ê–ù–°–ê–ú–ò -->
    <section class="screenings" th:if="${not availableDates.empty}">
        <h2>–°–µ–∞–Ω—Å—ã</h2>

        <!-- –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –¥–∞—Ç—ã + —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="screenings-header">
            <!-- –î–∞—Ç—ã (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫) -->
            <div class="screenings-dates">
                <a th:each="date : ${availableDates}"
                   th:href="@{/movies/{id}(id=${movie.id}, date=${date})}"
                   class="date-pill"
                   th:classappend="${date} == ${selectedDate} ? ' date-pill--active' : ''">
                    <span class="date-pill__day"
                          th:text="${#temporals.format(date, 'dd')}">28</span>
                    <span class="date-pill__month"
                          th:text="${#temporals.format(date, 'MMM')}">–Ω–æ—è</span>
                </a>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–Ω—è -->
            <div class="screenings-filter">
                <button type="button" class="filter-btn" id="timeFilterBtn">
                    <span id="timeFilterLabel">–í–µ—Å—å –¥–µ–Ω—å</span>
                    <span class="filter-btn__icon">‚åÑ</span>
                </button>
                <div class="filter-menu" id="timeFilterMenu">
                    <button type="button" class="filter-menu__item"
                            data-filter="all" data-label="–í–µ—Å—å –¥–µ–Ω—å">
                        –í–µ—Å—å –¥–µ–Ω—å
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="morning" data-label="–£—Ç—Ä–æ">
                        –£—Ç—Ä–æ 06:00 ‚Äì 12:00
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="day" data-label="–î–µ–Ω—å">
                        –î–µ–Ω—å 12:00 ‚Äì 18:00
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="evening" data-label="–í–µ—á–µ—Ä">
                        –í–µ—á–µ—Ä 18:00 ‚Äì 00:00
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="night" data-label="–ü–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏">
                        –ü–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏
                    </button>
                </div>
            </div>
        </div>

        <div th:if="${not screeningsForDay.empty}">
            <p class="screenings-subtitle">
                –°–µ–∞–Ω—Å—ã –Ω–∞
                <span th:text="${#temporals.format(selectedDate, 'dd.MM.yyyy')}">–¥–∞—Ç—É</span>:
            </p>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–ª–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–µ–º -->
            <div class="screenings-halls">
                <div class="hall-card" th:each="hallEntry : ${screeningsByHall}">
                    <div class="hall-card__header">
                        <span class="hall-card__title"
                              th:text="'–ó–∞–ª ' + ${hallEntry.key}">–ó–∞–ª 1</span>
                    </div>
                    <div class="hall-card__times">
                        <a th:each="screening : ${hallEntry.value}"
                           class="time-chip"
                           th:href="@{/tickets/book/{screeningId}(screeningId=${screening.id})}"
                           th:data-hour="${#temporals.format(screening.startTime, 'HH')}"
                           th:title="'–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç –Ω–∞ ' + ${#temporals.format(screening.startTime, 'HH:mm')}">
                            <span class="time-chip__time"
                                  th:text="${#temporals.format(screening.startTime, 'HH:mm')}">
                                19:00
                            </span>
                            <span class="time-chip__price"
                                  th:text="${screening.price != null ? '–æ—Ç ' + #numbers.formatDecimal(screening.price, 1, 0) + ' —Ä—É–±.' : '–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è'}">
                                –æ—Ç 400 —Ä—É–±.
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${screeningsForDay.empty}">
            <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É —Å–µ–∞–Ω—Å–æ–≤ –Ω–µ—Ç.</p>
        </div>
    </section>

    <!-- –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –¥–∞—Ç—ã —Å–µ–∞–Ω—Å–æ–≤ -->
    <section class="screenings" th:if="${availableDates.empty}">
        <h2>–°–µ–∞–Ω—Å—ã</h2>
        <p>–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–µ–∞–Ω—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª—å–º–∞ –Ω–µ—Ç.</p>
    </section>
</main>

<!-- JS-—Ñ–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–Ω—è -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var filterBtn = document.getElementById('timeFilterBtn');
        var filterMenu = document.getElementById('timeFilterMenu');
        var filterLabel = document.getElementById('timeFilterLabel');
        var timeChips = document.querySelectorAll('.time-chip');

        if (!filterBtn || !filterMenu) {
            return;
        }

        // –æ—Ç–∫—Ä—ã—Ç—å / –∑–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é
        filterBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            filterMenu.classList.toggle('open');
        });

        // –∫–ª–∏–∫ –≤–Ω–µ –º–µ–Ω—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ
        document.addEventListener('click', function () {
            filterMenu.classList.remove('open');
        });

        // –≤—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞
        filterMenu.addEventListener('click', function (e) {
            var item = e.target.closest('.filter-menu__item');
            if (!item) return;

            var filter = item.getAttribute('data-filter');
            var label = item.getAttribute('data-label') || item.textContent.trim();

            filterLabel.textContent = label;
            applyTimeFilter(filter);
            filterMenu.classList.remove('open');
        });

        function getSegmentByHour(hour) {
            var h = parseInt(hour, 10);
            if (h >= 6 && h < 12) return 'morning';   // 06-12
            if (h >= 12 && h < 18) return 'day';      // 12-18
            if (h >= 18 && h < 24) return 'evening';  // 18-00
            return 'night';                           // 00-06
        }

        function applyTimeFilter(filter) {
            timeChips.forEach(function (chip) {
                var hourStr = chip.getAttribute('data-hour');
                var segment = getSegmentByHour(hourStr || '0');

                var visible = (filter === 'all' || filter === segment);
                chip.style.display = visible ? 'inline-flex' : 'none';
            });
        }

        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äì "–í–µ—Å—å –¥–µ–Ω—å"
        applyTimeFilter('all');
    });
</script>
<script th:src="@{/js/theme.js}"></script>
</body>
</html>
