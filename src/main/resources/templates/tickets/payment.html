<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>–û–ø–ª–∞—Ç–∞ –±–∏–ª–µ—Ç–æ–≤</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

<header class="topbar">
    <div class="brand">
        <a th:href="@{/}">Absolute cinema</a>
    </div>
    <nav>
        <a th:href="@{/movies}">–§–∏–ª—å–º—ã</a>
        <a th:href="@{/about}">–û –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–µ</a>
        <span th:if="${#authorization.expression('hasRole(''USER'')')}">
            <a th:href="@{/user/profile}">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a th:href="@{/user/favorites}">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
        </span>
        <span th:if="${#authorization.expression('isAnonymous()')}">
            <a th:href="@{/tickets/guest}">–ú–æ–∏ –±–∏–ª–µ—Ç—ã</a>
        </span>
        <span th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
            <a th:href="@{/admin/movies}">–ê–¥–º–∏–Ω: –§–∏–ª—å–º—ã</a>
            <a th:href="@{/admin/screenings}">–ê–¥–º–∏–Ω: –°–µ–∞–Ω—Å—ã</a>
            <a th:href="@{/admin/users}">–ê–¥–º–∏–Ω: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        </span>
    </nav>
    <div class="auth">
        <a th:if="${#authorization.expression('isAnonymous()')}"
           th:href="@{/login}">–í–æ–π—Ç–∏</a>

        <span th:if="${#authorization.expression('isAuthenticated()')}">
            <span th:text="${#authentication.name}">user</span>
            <form th:action="@{/logout}" method="post" class="inline">
                <button type="submit" class="link-button">–í—ã–π—Ç–∏</button>
            </form>
        </span>
        <button type="button" class="theme-toggle" onclick="toggleTheme()">
            üåô –¢—ë–º–Ω–∞—è
        </button>
    </div>
</header>

<main class="container booking-page">
    <h1>–û–ø–ª–∞—Ç–∞ –±–∏–ª–µ—Ç–æ–≤</h1>

    <section class="ticket-screening-info">
        <p><span class="tag">–§–∏–ª—å–º:</span>
            <strong th:text="${screening.movie.title}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞</strong></p>
        <p><span class="tag">–ù–∞—á–∞–ª–æ:</span>
            <span th:text="${#temporals.format(screening.startTime, 'dd.MM.yyyy HH:mm')}"></span></p>
        <p><span class="tag">–ó–∞–ª:</span>
            <span th:text="${screening.hall}"></span></p>
        <p><span class="tag">–ú–µ—Å—Ç–∞:</span>
            <span th:each="s : ${selectedSeats}"
                  th:text="${s} + ' '">1-1 </span>
        </p>
        <p>
            <span class="tag">–ë–∏–ª–µ—Ç–æ–≤:</span>
            <strong th:text="${ticketsCount}">0</strong>
            &nbsp;&nbsp;
            <span class="tag">–ò—Ç–æ–≥–æ:</span>
            <strong th:text="${#numbers.formatDecimal(totalPrice, 1, 2)}">0.00</strong> —Ä—É–±.
        </p>
    </section>

    <section class="payment-section">
        <h2>–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã</h2>

        <div th:if="${emailError != null}" class="alert alert-danger"
             th:text="${emailError}">–û—à–∏–±–∫–∞</div>

        <form th:action="@{/tickets/pay}" method="post" class="payment-form">
            <input type="hidden" name="screeningId" th:value="${screening.id}"/>
            <input type="hidden" name="selectedSeats" th:value="${selectedSeatsRaw}"/>

            <div class="form-group">
                <label for="customerName">–ò–º—è –Ω–∞ –±–∏–ª–µ—Ç–µ</label>
                <input id="customerName" type="text" name="customerName"
                       th:value="${customerName}" required/>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cardNumber">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                    <input id="cardNumber" type="text" maxlength="19"
                           autocomplete="off"
                           inputmode="numeric"
                           placeholder="0000 0000 0000 0000" required/>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group small">
                    <label for="cardExpiry">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                    <input id="cardExpiry" type="text" maxlength="5"
                           autocomplete="off"
                           inputmode="numeric"
                           placeholder="MM/YY" required/>
                </div>
                <div class="form-group small">
                    <label for="cardCvv">CVV</label>
                    <input id="cardCvv" type="password" maxlength="4"
                           autocomplete="off"
                           inputmode="numeric"
                           placeholder="***" required/>
                </div>
            </div>

            <div class="form-group">
                <label>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>

                <input type="email" name="email"
                       th:if="${isAuthenticated}"
                       th:value="${prefilledEmail}"
                       placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"/>

                <input type="email" name="email"
                       th:if="${!isAuthenticated}"
                       th:value="${prefilledEmail}"
                       placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤)"
                       required/>
                <small class="hint">–ù–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞—à–∏ –±–∏–ª–µ—Ç—ã —Å QR-–∫–æ–¥–∞–º–∏.</small>
            </div>

            <div class="payment-qr-info">
                <p>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–æ—è–≤—è—Ç—Å—è QR-–∫–æ–¥—ã –±–∏–ª–µ—Ç–æ–≤.
                    –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å–æ —Å–≤–æ–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –≤—Ö–æ–¥–µ –≤ –∑–∞–ª.</p>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    –û–ø–ª–∞—Ç–∏—Ç—å [[${#numbers.formatDecimal(totalPrice, 1, 2)}]] —Ä—É–±.
                </button>
                <a th:href="@{/tickets/book/{id}(id=${screening.id})}"
                   class="btn btn-outline">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –º–µ—Å—Ç</a>
            </div>
        </form>
    </section>
</main>

<!-- –ú–∞—Å–∫–∏ –≤–≤–æ–¥–∞ -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var cardNumberInput = document.getElementById('cardNumber');
        var cardExpiryInput = document.getElementById('cardExpiry');
        var cardCvvInput = document.getElementById('cardCvv');

        if (cardNumberInput) {
            cardNumberInput.addEventListener('keydown', function (e) {
                var allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
                if (allowedKeys.indexOf(e.key) !== -1) return;
                if (!/^\d$/.test(e.key)) e.preventDefault();
            });

            cardNumberInput.addEventListener('input', function () {
                var value = cardNumberInput.value.replace(/\D/g, '');
                if (value.length > 16) value = value.substring(0, 16);
                var parts = [];
                for (var i = 0; i < value.length; i += 4) {
                    parts.push(value.substring(i, i + 4));
                }
                cardNumberInput.value = parts.join(' ');
            });
        }

        if (cardExpiryInput) {
            cardExpiryInput.addEventListener('keydown', function (e) {
                var allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
                if (allowedKeys.indexOf(e.key) !== -1) return;
                if (!/^\d$/.test(e.key)) e.preventDefault();
            });

            cardExpiryInput.addEventListener('input', function () {
                var value = cardExpiryInput.value.replace(/\D/g, '');
                if (value.length > 4) value = value.substring(0, 4);
                if (value.length >= 3) {
                    cardExpiryInput.value = value.substring(0, 2) + '/' + value.substring(2);
                } else {
                    cardExpiryInput.value = value;
                }
            });
        }

        if (cardCvvInput) {
            cardCvvInput.addEventListener('keydown', function (e) {
                var allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
                if (allowedKeys.indexOf(e.key) !== -1) return;
                if (!/^\d$/.test(e.key)) e.preventDefault();
            });
        }
    });
</script>
<script th:src="@{/js/theme.js}"></script>
</body>
</html>
