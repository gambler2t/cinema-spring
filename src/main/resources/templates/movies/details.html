<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${movie.title}">Фильм</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

<header class="topbar">
    <div class="brand"><a th:href="@{/}">Cinema</a></div>
    <nav>
        <a th:href="@{/movies}">Фильмы</a>
        <a th:href="@{/about}">О кинотеатре</a>
        <span th:if="${#authorization.expression('hasRole(''USER'')')}">
            <a th:href="@{/user/profile}">Профиль</a>
            <a th:href="@{/user/favorites}">Избранное</a>
        </span>
        <span th:if="${#authorization.expression('isAnonymous()')}">
            <a th:href="@{/tickets/guest}">Мои билеты</a>
        </span>
        <span th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
            <a th:href="@{/admin/movies}">Админ</a>
        </span>
    </nav>
    <div class="auth">
        <a th:if="${#authorization.expression('isAnonymous()')}"
           th:href="@{/login}">Войти</a>
        <span th:if="${#authorization.expression('isAuthenticated()')}">
            <span th:text="${#authentication.name}">user</span>
            <form th:action="@{/logout}" method="post" class="inline">
                <button type="submit" class="link-button">Выйти</button>
            </form>
        </span>
    </div>
</header>

<main class="container movie-details">
    <section class="movie-hero">
        <div class="movie-hero-poster">
            <img th:if="${movie.posterUrl != null and !movie.posterUrl.isEmpty()}"
                 th:src="${movie.posterUrl}"
                 th:alt="${movie.title}">
            <div th:if="${movie.posterUrl == null or movie.posterUrl.isEmpty()}"
                 class="movie-poster-placeholder">
                НЕТ ПОСТЕРА
            </div>
        </div>
        <div class="movie-hero-info">
            <h1 th:text="${movie.title}">Название</h1>

            <div class="movie-hero-actions">
                <!-- Для авторизованных пользователей -->
                <form th:if="${#authorization.expression('hasRole(''USER'')')}"
                      th:action="@{/user/favorites/{id}/toggle(id=${movie.id})}"
                      method="post"
                      class="inline">
                    <button type="submit"
                            class="btn"
                            th:class="${isFavorite} ? 'btn-danger' : 'btn-secondary'"
                            th:text="${isFavorite} ? 'Убрать из избранного' : 'В избранное'">
                        В избранное
                    </button>
                </form>
            </div>

            <p><strong>Жанр:</strong>
                <span th:text="${movie.genre != null ? movie.genre : 'Не указан'}">Жанр</span>
            </p>

            <p><strong>Режиссёр:</strong>
                <span th:text="${movie.director != null ? movie.director : 'Не указан'}">Режиссёр</span>
            </p>

            <p><strong>Страна:</strong>
                <span th:text="${movie.country != null ? movie.country : 'Не указана'}">Страна</span>
            </p>

            <p><strong>Длительность:</strong>
                <span th:text="${movie.durationMinutes != null ? movie.durationMinutes : '—'}">120</span> мин
            </p>
        </div>
    </section>

    <section class="movie-description" th:if="${movie.description != null and !movie.description.isEmpty()}">
        <h2>Описание</h2>
        <p th:text="${movie.description}">
            Описание фильма...
        </p>
    </section>

    <!-- НОВЫЙ БЛОК С СЕАНСАМИ -->
    <section class="screenings" th:if="${not availableDates.empty}">
        <h2>Сеансы</h2>

        <!-- верхняя панель: даты + фильтр по времени -->
        <div class="screenings-header">
            <!-- Даты (горизонтальный список) -->
            <div class="screenings-dates">
                <a th:each="date : ${availableDates}"
                   th:href="@{/movies/{id}(id=${movie.id}, date=${date})}"
                   class="date-pill"
                   th:classappend="${date} == ${selectedDate} ? ' date-pill--active' : ''">
                    <span class="date-pill__day"
                          th:text="${#temporals.format(date, 'dd')}">28</span>
                    <span class="date-pill__month"
                          th:text="${#temporals.format(date, 'MMM')}">ноя</span>
                </a>
            </div>

            <!-- Фильтр по времени дня -->
            <div class="screenings-filter">
                <button type="button" class="filter-btn" id="timeFilterBtn">
                    <span id="timeFilterLabel">Весь день</span>
                    <span class="filter-btn__icon">⌄</span>
                </button>
                <div class="filter-menu" id="timeFilterMenu">
                    <button type="button" class="filter-menu__item"
                            data-filter="all" data-label="Весь день">
                        Весь день
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="morning" data-label="Утро">
                        Утро 06:00 – 12:00
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="day" data-label="День">
                        День 12:00 – 18:00
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="evening" data-label="Вечер">
                        Вечер 18:00 – 00:00
                    </button>
                    <button type="button" class="filter-menu__item"
                            data-filter="night" data-label="После полуночи">
                        После полуночи
                    </button>
                </div>
            </div>
        </div>

        <div th:if="${not screeningsForDay.empty}">
            <p class="screenings-subtitle">
                Сеансы на
                <span th:text="${#temporals.format(selectedDate, 'dd.MM.yyyy')}">дату</span>:
            </p>

            <!-- Карточки залов с временем -->
            <div class="screenings-halls">
                <div class="hall-card" th:each="hallEntry : ${screeningsByHall}">
                    <div class="hall-card__header">
                        <span class="hall-card__title"
                              th:text="'Зал ' + ${hallEntry.key}">Зал 1</span>
                    </div>
                    <div class="hall-card__times">
                        <a th:each="screening : ${hallEntry.value}"
                           class="time-chip"
                           th:href="@{/tickets/book/{screeningId}(screeningId=${screening.id})}"
                           th:data-hour="${#temporals.format(screening.startTime, 'HH')}"
                           th:title="'Купить билет на ' + ${#temporals.format(screening.startTime, 'HH:mm')}">
                            <span class="time-chip__time"
                                  th:text="${#temporals.format(screening.startTime, 'HH:mm')}">
                                19:00
                            </span>
                            <span class="time-chip__price"
                                  th:text="${screening.price != null ? 'от ' + #numbers.formatDecimal(screening.price, 1, 0) + ' руб.' : 'Цена уточняется'}">
                                от 400 руб.
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${screeningsForDay.empty}">
            <p>На выбранную дату сеансов нет.</p>
        </div>
    </section>

    <!-- если вообще нет ни одной даты сеансов -->
    <section class="screenings" th:if="${availableDates.empty}">
        <h2>Сеансы</h2>
        <p>На данный момент сеансов для этого фильма нет.</p>
    </section>
</main>

<!-- JS-фильтр по времени дня -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var filterBtn = document.getElementById('timeFilterBtn');
        var filterMenu = document.getElementById('timeFilterMenu');
        var filterLabel = document.getElementById('timeFilterLabel');
        var timeChips = document.querySelectorAll('.time-chip');

        if (!filterBtn || !filterMenu) {
            return;
        }

        // открыть / закрыть меню
        filterBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            filterMenu.classList.toggle('open');
        });

        // клик вне меню закрывает его
        document.addEventListener('click', function () {
            filterMenu.classList.remove('open');
        });

        // выбор пункта фильтра
        filterMenu.addEventListener('click', function (e) {
            var item = e.target.closest('.filter-menu__item');
            if (!item) return;

            var filter = item.getAttribute('data-filter');
            var label = item.getAttribute('data-label') || item.textContent.trim();

            filterLabel.textContent = label;
            applyTimeFilter(filter);
            filterMenu.classList.remove('open');
        });

        function getSegmentByHour(hour) {
            var h = parseInt(hour, 10);
            if (h >= 6 && h < 12) return 'morning';   // 06-12
            if (h >= 12 && h < 18) return 'day';      // 12-18
            if (h >= 18 && h < 24) return 'evening';  // 18-00
            return 'night';                           // 00-06
        }

        function applyTimeFilter(filter) {
            timeChips.forEach(function (chip) {
                var hourStr = chip.getAttribute('data-hour');
                var segment = getSegmentByHour(hourStr || '0');

                var visible = (filter === 'all' || filter === segment);
                chip.style.display = visible ? 'inline-flex' : 'none';
            });
        }

        // по умолчанию – "Весь день"
        applyTimeFilter('all');
    });
</script>

</body>
</html>
